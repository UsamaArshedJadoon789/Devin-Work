<!DOCTYPE html>
<html>
<head>
    <title>USW Musicals Booking System</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .musical { border: 1px solid #ddd; padding: 15px; margin: 10px 0; }
        .form-group { margin: 10px 0; }
        button { padding: 8px 16px; background: #1a237e; color: white; border: none; cursor: pointer; }
    </style>
</head>
<body>
    <div class="container">
        <h1>USW Musicals Booking System</h1>
        
        <div id="musicals">
            <h2>Available Musicals</h2>
            <!-- Musicals will be loaded here -->
        </div>

        <div id="booking-form">
            <h2>Book Tickets</h2>
            <div class="form-group">
                <label>Student ID:</label>
                <input type="text" id="studentId" devinid="0" />
            </div>
            <div class="form-group">
                <label>Show Time:</label>
                <select id="showTimeId" devinid="1"></select>
            </div>
            <div class="form-group">
                <label>Number of Seats:</label>
                <input type="number" id="seats" min="1" value="1" devinid="2" />
            </div>
            <button onclick="bookTickets()" devinid="3">Book Now</button>
        </div>

        <div id="bookings">
            <h2>My Bookings</h2>
            <div class="form-group">
                <input type="text" id="searchStudentId" placeholder="Enter Student ID" devinid="4" />
                <button onclick="viewBookings()" devinid="5">View Bookings</button>
            </div>
            <div id="bookings-list">
                <!-- Bookings will be loaded here -->
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:80';

        async function loadMusicals() {
            try {
                const url = `${API_URL}/api/musicals`;
                console.log('Fetching musicals from:', url);
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    throw new Error(`Expected JSON response but got ${contentType}`);
                }
                
                const musicals = await response.json();
                console.log('Musicals data:', musicals);
            
            const musicalsDiv = document.getElementById('musicals');
            const showTimeSelect = document.getElementById('showTimeId');
            
            musicalsDiv.innerHTML = '<h2>Available Musicals</h2>';
            showTimeSelect.innerHTML = '';
            
            musicals.forEach(musical => {
                const musicalDiv = document.createElement('div');
                musicalDiv.className = 'musical';
                musicalDiv.innerHTML = `
                    <h3>${musical.title}</h3>
                    <p>${musical.description}</p>
                    <h4>Show Times:</h4>
                `;
                
                musical.showTimes.forEach(showTime => {
                    musicalDiv.innerHTML += `
                        <p>Date: ${new Date(showTime.dateTime).toLocaleString()}<br>
                        Available Seats: ${showTime.availableSeats}</p>
                    `;
                    
                    const option = document.createElement('option');
                    option.value = showTime.id;
                    option.text = `${musical.title} - ${new Date(showTime.dateTime).toLocaleString()}`;
                    showTimeSelect.appendChild(option);
                });
                
                musicalsDiv.appendChild(musicalDiv);
            });
            } catch (error) {
                console.error('Error loading musicals:', error);
                const musicalsDiv = document.getElementById('musicals');
                musicalsDiv.innerHTML = '<h2>Available Musicals</h2><p>Error loading musicals. Please try again later.</p>';
            }
        }

        async function bookTickets() {
            try {
                const booking = {
                    studentId: document.getElementById('studentId').value,
                    showTimeId: document.getElementById('showTimeId').value,
                    numberOfSeats: parseInt(document.getElementById('seats').value)
                };
                
                console.log('Booking tickets:', booking);
                const response = await fetch(`${API_URL}/api/bookings`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(booking)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                console.log('Booking result:', result);
                alert('Booking successful!');
            } catch (error) {
                console.error('Error booking tickets:', error);
                alert('Error booking tickets: ' + error.message);
            }
            
            loadMusicals();
        }

        async function viewBookings() {
            try {
                const studentId = document.getElementById('searchStudentId').value;
                console.log('Fetching bookings for student:', studentId);
                
                const response = await fetch(`${API_URL}/api/bookings/student/${studentId}`, {
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                console.log('Student bookings:', result);
                
                const bookingsList = document.getElementById('bookings-list');
                bookingsList.innerHTML = '<h3>Your Bookings:</h3>';
                
                if (!result || result.length === 0) {
                    bookingsList.innerHTML += '<p>No bookings found.</p>';
                } else {
                    result.forEach(booking => {
                        bookingsList.innerHTML += `
                            <div class="booking">
                                <p>Booking ID: ${booking.id}</p>
                                <p>Show Time: ${booking.showTimeId}</p>
                                <p>Number of Seats: ${booking.numberOfSeats}</p>
                                <p>Booking Time: ${new Date(booking.bookingTime).toLocaleString()}</p>
                            </div>
                        `;
                    });
                }
            } catch (error) {
                console.error('Error viewing bookings:', error);
                const bookingsList = document.getElementById('bookings-list');
                bookingsList.innerHTML = '<p>Error viewing bookings: ' + error.message + '</p>';
            }
        }

        // Load musicals when page loads
        loadMusicals();
    </script>
</body>
</html>
